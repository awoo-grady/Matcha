#!/bin/bash -l
#
# .prefix
#
# Matcha 1.0, Created by gradyzhuo, enoch_lee.
# Copyright © 2017, Matcha Inc. All rights reserved.
#

declare -x MATCHA_VERSION='1.0'
declare -x INSTALL_LIB_TARGET="$HOME/.matcha"

declare -x MATCHA_BUILDER_BASE
declare -x COMMAND_BASE
declare -x COMMAND
declare -x MODULES_FOLDER

declare -i -x DEBUG_MODE=1
declare -i -x BUILD_CI=1

declare -f @exec
declare -f @exists -f
declare -f command_exists
declare -f exists
declare -f terminate
declare -f welcome
declare -f tips
declare -f shell_session_update
declare -f @log

function welcome(){
  print ''
  print -c green -s bold '＃＃＃＃＃＃＃＃＃＃＃＃＃＃＃＃＃＃＃＃＃＃＃＃＃＃＃＃＃＃'
  print -c green -s bold  '＃　　　　　　　　　　　　　　　　　　　　　　　　　　　　＃'
  print -c green -s bold  '＃　　　　　　　～～　Ｗｅｌｃｏｍｅ　～～　　　　　　　　＃'
  print -c green -s bold  '＃　　　　　　Ｍａｔｃｈａ　Ｓｃｒｉｐｔｉｎｇ　　　　　　＃'
  print -c green -s bold  '＃　　　　　　　Ｖｅｒｓｉｏｎ　　１．０　　　　　　　　　＃'
  print -c green -s bold  '＃　　　　　　　　　　　　　　　　　　　　　　　　　　　　＃'
  print -c green -s bold  '＃＃＃＃＃＃＃＃＃＃＃＃＃＃＃＃＃＃＃＃＃＃＃＃＃＃＃＃＃＃'
  print ''
}

function tips(){
  print -c "green" "============================"
  print -c "green" -s "bold" "Now you can \`@import module\` module to do something."
  print -c "green" -s "bold" 'Try it!\n```\n    @import Prints\n    print -c "blue" Hello Matcha!\n```'
  prints "-c green -s bold 'And you will see the result: '" "-c blue 'Hello Matcha!'"
  print -c green -s bold "Enjoy it!"
}

function @import() {
  @exec import "$@"
}

function @exec() {

  COMMAND="$1"

  if [[ $(ls "$MATCHA_BUILDER_BASE/command") != *"$COMMAND"*  ]]; then
    print -c 'red' -s 'bold' "Command \`$1\` not found." 1>&2
    return 0
  fi

  if [[ -z $COMMAND ]]; then
    print -c "red" -s bold "-- Command name can't be empty! ----------"
    return 0
  fi

  PREVIOUS_COMMAND_BASE="$COMMAND_BASE"
  COMMAND_BASE="$MATCHA_BUILDER_BASE/command/$COMMAND"

  [[ -s "$COMMAND_BASE/source" ]] && source "$COMMAND_BASE/source" && return 0;

  if [[ -s "$COMMAND_BASE/main" ]]; then
    pushd "$COMMAND_BASE" >/dev/null 2>&1
    bash -l main "$@"
    popd >/dev/null 2>&1
  fi
  COMMAND_BASE="$PREVIOUS_COMMAND_BASE"
}

function shell_function_exists() {
    declare -f -F $1 >/dev/null 2>&1
    echo "$?"
}

function shell_command_exists() {
    command -v $1 >/dev/null 2>&1
    echo "$?"
}

# -f : function
# -c : command
function @exists() {
	_type="$1"
	_command="$2"

    if [[ "$_type" == "-f" ]]; then
      shell_function_exists $_command
    fi

    if [[ "$_type" == "-c" ]]; then
    	shell_command_exists $_command
    fi
}

function terminate(){

  declare error_code="$1"
  declare error_message="$2"

  if [[ "$error_message" != "" ]]; then
    print -c "red" -s bold "-- $error_message ----------"
  fi

  exit 1
}

function shell_session_update() {
  if [[ $? != 0 ]]; then
    did_terminate
    print -c "red" -s bold "Builder is terminated!"
  fi
}

function @log() {
  title="$1"
  DATETIME="$(date +"%y-%m-%d %H:%M:%S")"
  print -c cyan -s bold "[$DATETIME] $title"
}

function @error() {
  title="$1"
  DATETIME="$(date +"%y-%m-%d %H:%M:%S")"
  print -c cyan -s bold "[$DATETIME] $title" 1>&2
}
